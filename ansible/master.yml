---
- hosts: all
  become: true
  vars:
    pip_install_packages:
      - name: docker
    docker_users:
      - "centos"
    docker_compose_version: "1.22.0"

  roles:
    - geerlingguy.repo-epel
    - geerlingguy.pip
    - geerlingguy.docker

- hosts: all
  become: true
  tasks:
    - yum:
        name: git,go
        state: present
    - name: Create entries in /etc/hosts for all nodes
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item]['ansible_default_ipv4']['address'] }} {{ item }}.novalocal {{ item }}"
        regexp: "^.* {{ item }}$"
        create: no
        state: present
      with_items:
        - "{{ ansible_play_hosts }}"

- hosts: all
  tasks:
    - file:
        path: ~/go/github.com/JohnGarbutt/
        state: directory
    - git:
        repo: 'https://github.com/JohnGarbutt/data-acc.git'
        dest: ~/go/src/github.com/JohnGarbutt/data-acc

- hosts: slurm-master[0]
  vars:
      recreate: false
  tasks:
    - docker_service:
        project_src: ~/go/src/github.com/JohnGarbutt/data-acc/ansible/slurm-master
        pull: yes
        state: absent
        remove_volumes: yes
      when: recreate|bool
    - docker_service:
        project_src: ~/go/src/github.com/JohnGarbutt/data-acc/ansible/slurm-master
        pull: yes
      register: output
    - name: ensure slurm cluster registered in db
      shell: |
        sleep 10 && docker exec slurmctld bash -c "/usr/bin/sacctmgr --immediate add cluster name=linux" && docker restart slurmdbd slurmctld
      when: output.changed

- hosts: slurm-workers
  vars:
      recreate: false
  tasks:
    - docker_service:
        project_src: ~/go/src/github.com/JohnGarbutt/data-acc/ansible/slurm-worker
        pull: yes
        state: absent
        remove_volumes: yes
      when: recreate|bool
    - docker_service:
        project_src: ~/go/src/github.com/JohnGarbutt/data-acc/ansible/slurm-worker
        pull: yes

- hosts: dac-workers
  vars:
      recreate: false
  tasks:
    - docker_service:
        project_src: ~/go/src/github.com/JohnGarbutt/data-acc/ansible/dac-worker
        pull: yes
        state: absent
        remove_volumes: yes
      when: recreate|bool
    - docker_service:
        project_src: ~/go/src/github.com/JohnGarbutt/data-acc/ansible/dac-worker
        pull: yes
