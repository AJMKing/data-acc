---
- name: Format disks
  command: mkfs.ext4 -i 16384 -I 512 -J size=400 -Odir_index,filetype /dev/{{item}}
  loop: "{{ disks }}"
  when:
    - disks is defined
  tags: [ 'never', 'format']

- name: Setup disks
  block:

    - name: Create mount point dir
      file:
        path: /data/{{ group_names[0] }}/{{ item }}
        state: directory
        recurse: yes
      loop: "{{ disks }}"

    - name: Mount EXT4 OSTs
      command: mount -onoatime,nodiratime,nobarrier,user_xattr /dev/{{item}} /data/{{ group_names[0] }}/{{ item }}
      loop: "{{ disks }}"

  when:
    - disks is defined
  tags: [ 'never', 'mount']


- block:
    - set_fact:
        data_dir: "/data/{{ group_names[0] }}/{{ disks[0] }}/data"
    - name: make data dir
      file:
        path: "{{ data_dir }}"
        state: directory
        recurse: yes
  when:
    - disks is defined
  tags: [ 'never', 'mount']


- block:
    - set_fact:
        mds_dir: "/data/{{ group_names[0] }}/{{ disks[0] }}/mds"
    - name: make metadata dir
      file:
        path: "{{ mds_dir }}"
        state: directory
        recurse: yes
  when:
    - disks is defined
    - mds_host == ansible_host
  tags: [ 'never', 'mount']


- block:
    - set_fact:
        mgs_dir: "/data/{{ group_names[0] }}/{{ disks[0] }}/mgs"
    - name: make management dir
      file:
        path: "{{ mgs_dir }}"
        state: directory
        recurse: yes
  when:
    - disks is defined
    - mgs_host == ansible_host
  tags: [ 'never', 'mount']
